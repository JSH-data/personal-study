### Why we need this?
성능이 좋은 서버 한대보다 낮은 성능의 서버 여러대가 더 가격적인 측면에서 유리할 수 있습니다.
하지만 새로운 서버를 추가하는 경우 추가된 서버를 하나의 자원풀에 더하는 것이 쉽지만은 않습니다. 
이를 도와줄 수 있는 오픈소스로 쿠버네티스와 도커가 있습니다. 

##### 도커 스웜 정보확인
```
docker info | grep Swarm // Swarm: inactive
```

##### NTP
- 서버 클러스터링을 하기 전에는 반드시 각 서버의 시각을 NTP 등의 툴을 이용해 동기화해야 합니다. 서버 간에 설정 시각이 다를 경우 예상치 못한 오류가 발생할 수 있기 때문입니다. 

#### 도커 스웜 모드의 구조
- 스웜 모드는 매니저 노드와 워커 노드로 구성돼 있습니다. 
- 워커 노드는 실제로 컨테이너가 생성되고 관리되는 도커 서버입니다.
- 매니저 노드는 워커 노드를 관리하기 위한 도커 서버입니다. 하지만 매니저 노드에도 컨테이너가 생성될 수 있습니다. 워커 노드는 존재하지 않아도 되지만 매니저 노드는 반드시 하나 이상 존재해야합니다. 
- 도커 스웜은 매니저 노드의 절반에 장애가 생긴경우 운영을 중단합니다. 따라서 홀수개의 매니저를 두는 것이 이상적입니다. 

#### 도커 스웜 모드 클러스터 구축
```
docker swarm init --advertise-addr 192.168.0.100 // 다른 도커 서버가 매니저 노드에 접근하기 위한 IP 주소
```

#### 도커 스웜 포트 구조
- 스웜 매니저는 기본적으로 2377번 포트를 사용합니다.
- 노드 사이 통신에는 7946/tcp, 7946/udp 포트를 사용합니다.
- 스웜이 사용하는 네트워크인 ingress 오버레이 네트워크에 4789/tcp 포트를 사용합니다. 

#### 노드 추가하기
```
docker swarm join \
--token "..." \
192.168.0.100:2377
```

#### 노드 확인하기

```
docker node ls
```

#### 리더 노드 
- 매니저 노드는 일반적인 매니저 역할을 하는 노드와 리더 역할을 하는 노드로 나뉩니다. 
- 리더 매니저는 모든 매니저 노드에 대한 데이터 동기화와 관리를 담당하므로 항상 작동할 수 있는 상태여야합니다. 
- 리더 매니저 노드 다운 시 새로운 리더를 선출합니다. (Raft Consensus 알고리즘 활용)

#### 토크갱신
- 토큰은 외부에 노출되면 안됩니다.
```
docker swarm join-token --rotate manager // manager 노드를 추가하는 토큰을 갱신합니다. 
```

#### 워커 노드를 삭제하는 방법
- 해당 노드에 접속하여 아래의 명령어를 입력합니다 
```
docker swarm leave

// 매니저 노드는 force 옵션을 통해 삭제가 가능하며 매니저 노드의 부재시 스웜을 사용할 수 없습니다
docker swarm leave --force
```

#### 노드의 역할 변경
- 매니저 노드가 1개인경우 demote가 불가능합니다.
```
docker node promote // 워커 노드를 매니저 노드로 변경

docker node demote // 매니저 노드를 워커 노드로 변경
```

#### 스웜 모드 서비스
- 스웜 모드에서 제어의 단위는 서비스입니다. 
- 서비스는 같은 이미지에서 생성된 컨테이너의 집합이며 이러한 컨테이너는 태스크라고 합니다. 
- 스웜 스케줄러에 정의에 따라 함께 생성된 컨테이너를 레플리카라고 합니다.
- 만약 워커에 장애가 발생하여 스케줄러에 정의된 숫자 미만으로 컨테이너의 숫자가 떨어진 경우 새롭게 생성합니다. 
- 롤링 업데이트를 통해 서비스 내 컨테이너들의 이미지 버전을 일괄적으로 올릴 수 있습니다. 
- 롤링 업데이트를 사용하는 경우 서비스 중단이 일어나지 않고 버전을 올릴 수 있습니다. 

#### 서비스 생성
- 서비스를 제어하는 명령어는 매니저 노드에서만 가능합니다. 
```
docker service create \
ubuntu:14.04 \
/bin/sh -c "while true; do echo hello; sleep 1; done"
```
 - 서비스 내 컨테이너는 모두 detached 모드입니다. 

#### 서비스 확인
```
docker service ls // 스웜 클러스터 내의 서비스
docker service ps [서비스 이름] // 서비스의 더 자세한 정보
docker service rm [서비스 이름]
```

#### 실제 서비스 생성 예제
- nginx 예제
```
docker service create --name myweb \
--replica 2 \
-p 80:80 \
nginx
```
- 레플리카 개수 업그레이드

```
docker service scale myweb=4
```

#### 글로벌 모드
- 서비스는 2가지 모드가 있습니다. 
- 하나는 앞서 본 복제 모드이며 두번째는 글로벌 모드입니다. 
- 글로벌 모드는 스웜 클러스터 내에서 사용할 수 있는 모든 노드에 컨테이너를 반드시 하나씩 생성합니다. 
- 따라서 레플리카의 수가 필요하지 않습니다. 

```
docker service create --name global_web \
--mode global \
nginx 
```

#### 장애 복구 서비스


#### 서비스 롤링 업데이트

#### 서비스에 config, secret 전달하기