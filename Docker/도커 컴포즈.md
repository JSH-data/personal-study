#### 도커 컴포즈의 프로젝트, 서비스 컨테이너
- 도커 컴포즈는 컨테이너를 프로젝트 및 서비스 단위로 구분하므로 컨테이너의 이름은 다음과 같은 형식입니다. 
	- {프로젝트이름}_{서비스 이름}_{서비스 내에서 컨테이너의 번호}
- 스웜 모드에서의 서비스와 비슷하게 차례대로 증가하는 컨테이너의 번호를 붙여 서비스 내의 컨테이너를 구별합니다.
	- `docker-compose scale mysql=2`
- 특정 서비스의 컨테이너만 생성하는 방법
	- `docker-compose up -d mysql`
- docker-compose로 생성된 컨테이너 목록 확인하기
	- `docker-compose ps`
- 생성된 프로젝트 삭제하기, 삭제 시 서비스 컨테이너 또한 전부 종료 후 삭제됨
	- `docker-compose down`
- docker-compose는 원래 현재 디렉터리의 이름으로 된 프로젝트를 제어합니다. 하지만 `-p` 옵션을 통해 하나의 docker-compose 파일로 서로 이름이 다른 여러 개의 프로젝트를 생성하고 제어할 수 있습니다. 
	- `docker-compose -p myproject up -d`

#### YAML 파일 작성
- YAML 파일은 크게 버전 정의, 서비스 정의 , 볼륨 정의, 네트워크 정의의 4가지 항목으로 구성됩니다. 
- 이 가운데 서비스 정의를 많이 사용하며 볼륨, 네트워크 정의는 서비스로 생성된 컨테이너에 선택적으로 사용됩니다. 
- 도커는 기본적으로 현재 디렉토리 혹은 상위 디렉토리에서 docker-compose 명령어의 -f 옵션을 사용하면 yml 파일의 위치와 이름을 지정할 수 있습니다. 
	- `docker-compose -f {compose.yml} up -d`

##### 버전 정의
- 버전 3은 도커 스웜모드와 호환되는 버전이므로 가능하면 최신 버전의 도커 컴포즈를 사용하는 것이 좋습니다. 
- 버전 항목은 일반적으로 가장 윗부분에 명시합니다.
	- `version '3.0'`

##### 서비스 정의
- 서비스는 도커 컴포즈로 생성한 컨테이너 옵션을 정의합니다. 
- 이 항목에 쓰인 서비스는 컨테이너로 구현되며 하나의 프로젝트로서 도커 컴포즈에 의해 관리됩니다. 
- 서비스의 이름은 services의 하위 항목으로 정의하고, 컨테이너의 옵션 서비스 이름의 하위 항목에 정의합니다. 
```
services:
	my_container_1:
		image: 
	my_container_2: 
		image:
```
- `image` 서비스의 컨테이너를 생성할 때 쓰일 이미지의 이름을 설정합니다. 이미지가 도커에 없다면 저장소에서 내려받습니다.
```yaml
services:
	my_container_1:
		image: image-name:tag
```
- `links` docker run 명령어의 --link와 같으며, 다른 서비스에 서비스 명단으로 접근할 수 있도록 설정합니다. 
```
services:
	web:
		links:
			- db
			- db:database
			- redis
```

- `environment` docker run의 --env, -e 옵션과 동일합니다. 서비스의 컨테이너 내부에서 사용할 환경변수를 지정하며 딕셔너리나 배열 형태로 사용할 수 있습니다. 
```
services:
	web:
		environment:
			- MYSQL_ROOT_PASSWORD=mypassword
			혹은
		environment:
			- MYSQL_ROOT_PASSWORD: mypassword
```
- `command`: 컨테이너가 실행될 때 실행할 명령어를 설정합니다. 
- `depends_on` 특정 컨테이너에 대한 의존 관계를 나타내며, 이 항목에 명시된 컨테이너가 먼저 생성되고 실행됩니다. `depends_on`은 서비스 이름으로만 접근할 수 있습니다.
- `--no-deps`를 사용할 경우 의존성 없는 컨테이너를 생성할 수 있습니다. 
- `links`, `depends_on` 두가지 모두 실행 순서만 설정할 뿐 컨테이너 내부의 애플리케이션이 준비된 상태에 대해서는 확인하지 않습니다. 컨테이너에 셸스크립트를 entrypoint로 지정하는 방법을 통해 준비 상태를 보장할 수 있습니다. 
```
services: 
	web:
		entrypoint: ./sync_script.sh mysql:3306

...

until (상태를 확인할 수 있는 명령어); do
	echo "depend container is not available yet"
	sleep 1
done
echo "depends_on container is ready"
```
- `ports` 서비스의 컨테이너를 개방할 포트를 설정합니다. 
- `build` 빌드 항목에 정의된 Dockerfile에서 이미지를 빌드해 서버스의 컨테이너를 생성하도록 설정합니다. 
- `extends` 다른 Yaml 파일이나 현재 Yaml 파일에서 서비스 속성을 상속받게 설정합니다. 
	- 단, depends_on, links, volumes_from 항목은 각 컨ㅌ이너 사이의 의존성을 내포하고 있으므로 extends로 상속받을 수 없습니다. 

##### 네트워크 정의
- `driver` Yaml 파일에서 driver 항목을 정의해 서비스의 컨테이너가 브리지 네트워크가 아닌 다른 네트워크를 사용하도록 설정할 수 있습니다. 
- `ipam` IP Adress Manager를 위해 사용할 수 있는 옵션으로서 subnet, ip 범위 등을 설정할 수 있습니다. 

##### 볼륨 정의
- `driver` 볼륨을 생성할 때 사용될 드라이버를 설정합니다. 

#### YAML 파일 검증하기
- YAML 파일을 작성할 때 오타 검사나 파일 포맷이 적절한지 등을 검사하려면 `dcoker-compose config` 명령어를 사용합니다. 

#### 도커 컴포즈 네트워크
- YAML 파일에 네트워크 항목을 정의하지 않으면 도커 컴포즈는 프로젝트별로 브리지 타입의 네트워크를 생성합니다. 
- 서비스 내의 컨테이너는 --net-alias가 서비스의 이름을 갖도록 자동 설정되므로 이 네트워크에 속한 컨테이너는 서비스의 이름으로 서비스 내의 컨테이너에 접근할 수 있습니다.

##### 도커 스웜 모드와 함꼐 사용하기
- 스택은 YAML 파일에서 생성된 컨테이너의 묶음으로서 YAML 파일로 스택을 생성하면 YAML 파일에 정의된 서비스가 스웜 모드의 클러스터에서 일괄적으로 생성됩니다. 즉, YAML 파일에 정의된 서비스가 스웜 모드의 클러스터에서 일괄적으로 생성됩니다. 즉, YAML 파일에 정의된 서비스가 스웜모드의 서비스로 변환된 것입니다. 
- 단, stack은 docker-compose가 아닌 docker stack으로 제어해야합니다. 스택은 컴포즈가 아닌 스웜 모드 클러스터 매니저에 의해 생성된 것이기 때문입니다.
- 스택 생성하기
```
docker stack deploy -c docker-compose.yml mystack
```